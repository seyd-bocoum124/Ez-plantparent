<mat-stepper [linear]="true" #stepper (selectionChange)="onStepChange($event)">
  <mat-step [editable]="!isBefore(StepIndex.TAKE_PICTURE) && !newMaintenanceSheet" [completed]="isStepPassed(StepIndex.TAKE_PICTURE)">
    <ng-template matStepLabel>Photographier</ng-template>

    @if(identificationStage === IdentificationStage.TAKING_PICTURES) {
      <div class="camera-container">
        <app-camera
          (photosChange)="onPhotosUpdate($event)"
          (videoTap)="onVideoTap()">
        </app-camera>
        @if(!photos || photos.length < 5) {
          <button mat-fab class="capture-button" (click)="takePhoto()">
            <mat-icon>photo_camera</mat-icon>
          </button>
        }
        @if(showFlash) {
          <div class="flash-overlay"></div>
        }
      </div>

      <div class="photo-preview">
        @for (photo of photos; let i = $index; track i) {
          <div class="photo-item">
            <img [src]="getSafeUrl(photo)" alt="Photo {{i + 1}}" />
            <button mat-button (click)="removePhoto(i)">❌</button>
          </div>
        }
      </div>

      <button mat-raised-button color="primary" (click)="submitPictures()" [disabled]="photos.length === 0">
        Soumettre {{ photos.length }} photo(s)
      </button>
    } @else if(identificationStage === IdentificationStage.WAIT_SUGGESTIONS) {
      <div>Waiting for suggestions...</div>
      <mat-spinner></mat-spinner>
    }
  </mat-step>
  <mat-step [editable]="!isBefore(StepIndex.SELECT_SUGGESTION) && !newMaintenanceSheet" [completed]="isStepPassed(StepIndex.SELECT_SUGGESTION)">
    <ng-template matStepLabel>Identifier</ng-template>
    @if(identificationStage === IdentificationStage.DISPLAY_SUGGESTIONS) {
      <div class="results">
        @for (result of suggestions; let i = $index; track i) {
          <div class="result-card">
            <h2>{{ result.scientificNameWithoutAuthor }}</h2>
            <div>
            <p><strong>Scientific name :</strong> {{ result.scientificName }}</p>
              <button mat-button (click)="choseResult(i)">Choisir</button>
            </div>

            @if(result.commonNames.length) {
              <p>
                <strong>Noms communs :</strong> {{ result.commonNames.join(', ') }}
              </p>
            }
            <p><strong>Score :</strong> {{ result.score | percent:'1.0-2' }}</p>

            <div class="images">
              <div *ngFor="let img of result.images">
                <img [src]="img.url" [alt]="result.scientificNameWithoutAuthor" />
                <small>{{ img.organ }}</small>
              </div>
            </div>
          </div>
        }
      </div>
    } @else if(identificationStage === IdentificationStage.SUGGESTION_CHOSEN && selected) {
      <button matButton="filled" (click)="identificationStage=IdentificationStage.DISPLAY_SUGGESTIONS">Faire une autre sélection</button>
      <button matButton="filled" (click)="goNextStep()">Continuer</button>
      <div class="result-card">
        <h2>{{ selected.scientificNameWithoutAuthor }}</h2>
        <div>
        <p><strong>Scientific name :</strong> {{ selected.scientificName }}</p>
        </div>

        @if(selected.commonNames.length) {
          <p>
            <strong>Noms communs :</strong> {{ selected.commonNames.join(', ') }}
          </p>
        }
        <p><strong>Score :</strong> {{ selected.score | percent:'1.0-2' }}</p>

        <div class="images">
          <div *ngFor="let img of selected.images">
            <img [src]="img.url" [alt]="selected.scientificNameWithoutAuthor" />
            <small>{{ img.organ }}</small>
          </div>
        </div>
      </div>
    }
  </mat-step>
  <mat-step [editable]="!isBefore(StepIndex.GIVE_A_NAME) && !newMaintenanceSheet" [completed]="isStepPassed(StepIndex.GIVE_A_NAME)">
    <ng-template matStepLabel>Créer</ng-template>
    @if(identificationStage==IdentificationStage.GIVE_A_NAME) {
      <app-plant-naming-form (submitForm)="onNameSubmitted($event)"></app-plant-naming-form>
    } @else if (identificationStage==IdentificationStage.WAIT_MAINTENANCE_SHEET) {
      <div>Waiting for maintenance sheet creation</div>
      <mat-spinner></mat-spinner>
    }
  </mat-step>
  <mat-step>
    <ng-template matStepLabel>Confirmer</ng-template>
    <app-maintenance-sheet-display [sheet]="newMaintenanceSheet"></app-maintenance-sheet-display>
    <button matButton="filled" [routerLink]="['/my-plants']">Retour à mes plantes</button>
  </mat-step>
</mat-stepper>




